@page "/Compartments"
@using Microsoft.EntityFrameworkCore
@using MedicineDispencer.Data
@inject PillDispenserContext Db
@inject IJSRuntime JSRuntime

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">💊 Medicijn Dispenser Status</h3>
        </div>
        <div class="card-body">
            @if (compartments == null || compartments.Count == 0)
            {
                <div class="alert alert-warning text-center">
                    <strong>⚠️ Geen medicijnen geconfigureerd.</strong><br />
                    Ga naar de <a href="/Configure">configuratiepagina</a> om te starten.
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var compartment in compartments)
                    {
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Compartiment @compartment.CompartmentNumber</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Medicijn:</strong> @compartment.Medication?.Name (@compartment.Medication?.Dosage)</p>
                                    <p><strong>Voorraad:</strong> @compartment.Stock tabletten</p>
                                    <p><strong>Volgende dosering:</strong> @GetNextDoseTime(compartment)</p>

                                    <button class="btn btn-outline-success btn-sm" @onclick="() => TriggerMedicijnHerinnering(compartment.Id)">
                                        🔔 Test Herinnering
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Compartment> compartments = new();

    protected override async Task OnInitializedAsync()
    {
        compartments = await Db.Compartments
            .Include(c => c.Medication)
            .Include(c => c.DosingTimes)
            .ToListAsync();
    }

    private void TriggerMedicijnHerinnering(int id)
    {
        Console.WriteLine($"Reminder triggered for Compartment {id}");
    }

    private string GetNextDoseTime(Compartment compartment)
    {
        if (compartment.DosingTimes == null || compartment.DosingTimes.Count == 0)
            return "Geen doseringen gepland";

        var now = DateTime.Now;
        var times = compartment.DosingTimes
            .Select(dt => TimeSpan.FromSeconds(dt.IntervalSeconds))
            .ToList();

        // Calculate next dose time from now
        var nextDose = times
            .Select(interval => now.Add(interval))
            .OrderBy(t => t)
            .FirstOrDefault();

        var remaining = nextDose - now;
        return $"{remaining:mm\\:ss} (in {remaining.TotalSeconds:F0} sec)";
    }

    
}

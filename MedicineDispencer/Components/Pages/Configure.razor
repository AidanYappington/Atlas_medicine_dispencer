@page "/Configure"
@using System
@using System.Collections.Generic
@using System.Linq
@using MedicineDispencer.Data

@inject PillDispenserContext Db
@inject IJSRuntime JSRuntime

<div class="container">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Compartiment Configuratie</h3>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="medication-name" class="form-label">Medicijn naam:</label>
                <input id="medication-name" type="text" class="form-control" @bind="configMedicationName" />
            </div>

            <div class="mb-3">
                <label for="medication-dosage" class="form-label">Dosering:</label>
                <input id="medication-dosage" type="text" class="form-control" @bind="configMedicationDosage" />
            </div>

            <div class="mb-3">
                <label class="form-label">Doseringstijden:</label>

                @foreach (var time in configDosingTimes)
                {
                    var index = configDosingTimes.IndexOf(time);
                    <div class="input-group mb-2">
                        <input type="time" class="form-control" value="@time.ToString(@"hh\:mm")"
                               @onchange="@(e => UpdateDosingTime(index, e.Value?.ToString()))" />
                        <button class="btn btn-outline-danger" @onclick="() => RemoveDosingTime(index)">Verwijder</button>
                    </div>
                }

                <button class="btn btn-outline-primary" @onclick="AddDosingTime">Tijdstip toevoegen</button>
            </div>

            <div class="mb-3">
                <label for="medication-stock" class="form-label">Beginvoorraad:</label>
                <input id="medication-stock" type="number" class="form-control" @bind="configMedicationStock" min="0" />
            </div>

            <button class="btn btn-primary" @onclick="SaveCompartmentConfig">Opslaan</button>
        </div>
    </div>
</div>

@code {
    private string configMedicationName = "";
    private string configMedicationDosage = "";
    private List<TimeSpan> configDosingTimes = new();
    private int configMedicationStock = 0;

    private void AddDosingTime() => configDosingTimes.Add(new TimeSpan(8, 0, 0));

    private void UpdateDosingTime(int index, string? timeString)
    {
        if (timeString != null && index >= 0 && index < configDosingTimes.Count)
        {
            var parts = timeString.Split(':');
            if (parts.Length == 2 &&
                int.TryParse(parts[0], out int hours) &&
                int.TryParse(parts[1], out int minutes))
            {
                configDosingTimes[index] = new TimeSpan(hours, minutes, 0);
            }
        }
    }

    private void RemoveDosingTime(int index)
    {
        if (index >= 0 && index < configDosingTimes.Count)
        {
            configDosingTimes.RemoveAt(index);
        }
    }

    private void SaveCompartmentConfig()
    {
        if (string.IsNullOrWhiteSpace(configMedicationName) || string.IsNullOrWhiteSpace(configMedicationDosage))
            return;

        // Check if this medication already exists in the database
        var medication = Db.Medications
            .FirstOrDefault(m => m.Name == configMedicationName && m.Dosage == configMedicationDosage);

        // If not found, create a new one
        if (medication == null)
        {
            medication = new Medication
            {
                Name = configMedicationName,
                Dosage = configMedicationDosage
            };
            Db.Medications.Add(medication);
            Db.SaveChanges();
        }

        var newCompartment = new Compartment
        {
            Medication = medication,
            Stock = configMedicationStock,
            DosingTimes = configDosingTimes.Select(t => new DosingTime { Time = t }).ToList()
        };

        Db.Compartments.Add(newCompartment);
        Db.SaveChanges();

        // Clear form after save
        configMedicationName = "";
        configMedicationDosage = "";
        configMedicationStock = 0;
        configDosingTimes.Clear();
    }
}

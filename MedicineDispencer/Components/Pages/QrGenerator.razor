@page "/QrGenerator"
@using System.Text.Json
@using Net.Codecrete.QrCodeGenerator

<h1>QR Code Generator</h1>

<div class="card mb-4">
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">Medicijn Naam</label>
            <input class="form-control" @bind="MedicijnNaam" />
        </div>
        <div class="mb-3">
            <label class="form-label">Dosis</label>
            <input class="form-control" @bind="Dosis" />
        </div>
        <div class="mb-3">
            <label class="form-label">Status</label>
            <input class="form-control" type="number" @bind="Status" />
        </div>
        <div class="mb-3">
            <label class="form-label">Voorraad</label>
            <input class="form-control" type="number" @bind="Voorraad" />
        </div>
        <div class="mb-3">
            <label class="form-label">Doseringstijden (HH:mm:ss, komma gescheiden)</label>
            <input class="form-control" @bind="DoseringstijdenInput" />
        </div>
        <button class="btn btn-primary" @onclick="GenerateQr">Genereer QR</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(QrSvg))
{
    <div class="mb-3">
        <div>@((MarkupString)QrSvg)</div>
    </div>
    <a class="btn btn-success"
       href="@QrSvgDownloadUrl"
       download=@($"qr_{MedicijnNaam}_{DateTime.Now:yyyyMMdd_HHmmss}.svg")>
        Download QR Code
    </a>
    <div class="mt-3">
        <label>JSON:</label>
        <pre>@JsonString</pre>
    </div>
}

@code {
    private string MedicijnNaam { get; set; } = "";
    private string Dosis { get; set; } = "";
    private int Status { get; set; } = 0;
    private int Voorraad { get; set; } = 0;
    private string DoseringstijdenInput { get; set; } = "08:00:00";
    private string? QrSvg;
    private string? JsonString;

    private string? QrSvgDownloadUrl => 
        QrSvg is null ? null : $"data:image/svg+xml;utf8,{Uri.EscapeDataString(QrSvg)}";

    private void GenerateQr()
    {
        var obj = new {
            MedicijnNaam,
            Dosis,
            Status,
            Voorraad,
            DoseringstijdenPerDag = DoseringstijdenInput.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries),
            LaatsteOpeningTijd = (string?)null
        };

        JsonString = JsonSerializer.Serialize(obj, new JsonSerializerOptions { WriteIndented = true });

        var qr = QrCode.EncodeText(JsonString, QrCode.Ecc.Medium);
        QrSvg = qr.ToSvgString(4);
    }
}
